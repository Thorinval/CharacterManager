@using CharacterManager.Server.Models
@using CharacterManager.Server.Services
@using CharacterManager.Components.Forms
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using CharacterManager.Server.Data;
@using System.Linq;

<link rel="stylesheet" href="/css/CreerClassementModal.css" />

@inject IModalService ModalService
@inject PersonnageService PersonnageService
@inject HistoriqueClassementService HistoriqueClassementService

<div class="modal-header-premium sticky-header">
    <i class="bi bi-clipboard-plus header-icon"></i>

    <div class="header-text">
        <h2 class="modal-title-premium">@(IsEdit ? "Éditer un classement" : "Créer un classement")</h2>
        <p class="modal-subtitle-premium">@(IsEdit ? "Mettre à jour les valeurs saisissables" : "Enregistrer une nouvelle entrée dans l'historique")</p>
    </div>
</div>

<div class="modal-body">
    <EditForm id="classementForm" EditContext="@editContext" OnValidSubmit="SaveClassement">
        <DataAnnotationsValidator />

        <h4 class="section-title">Informations générales</h4>

        <div class="bloc-infos-premium">

            <div class="info-item">
                <label for="dateEnregistrementInput">
                    <i class="bi bi-calendar3"></i>
                    Date
                </label>
                <InputDate Type="InputDateType.Date" id="dateEnregistrementInput" @bind-Value="form.DateEnregistrement"
                    class="@($"form-control form-control-sm {GetValidationClass(nameof(form.DateEnregistrement))}")" />
                <ValidationMessage For="@(() => form.DateEnregistrement)" />
            </div>

            <div class="info-item">
                <label for="ligueInput">
                    <i class="bi bi-shield-check"></i>
                    Ligue
                </label>
                <InputSelect int? id="ligueInput" @bind-Value="form.Ligue"
                    class="@($"form-select form-select-sm {GetValidationClass(nameof(form.Ligue))}")">
                    <option value="">Sélectionner</option>
                    @foreach (var ligue in LigueSteps)
                    {
                        <option value="@ligue">Ligue @ligue</option>
                    }
                    <option value="@EliteTop50Value">Elite - Top 50</option>
                </InputSelect>
                <ValidationMessage For="@(() => form.Ligue)" />
            </div>

            <div class="info-item">
                <label for="scoreInput">
                    <i class="bi bi-graph-up-arrow"></i>
                    Score
                </label>
                <InputNumber id="scoreInput" @bind-Value="form.Score"
                    class="@($"form-control form-control-sm {GetValidationClass(nameof(form.Score))}")" />
                <ValidationMessage For="@(() => form.Score)" />
            </div>

        </div>

        <h4 class="section-title">Classements</h4>

        <div class="bloc-classements-premium">

            <div class="classement-item">
                <label for="nutakuInput" class="chip-label chip-nutaku">
                    <i class="bi bi-globe"></i> Nutaku
                </label>
                <InputNumber id="nutakuInput" @bind-Value="form.Nutaku"
                    class="@($"form-control form-control-sm {GetValidationClass(nameof(form.Nutaku))}")" />
                <ValidationMessage For="@(() => form.Nutaku)" />
            </div>

            <div class="classement-item">
                <label for="top150Input" class="chip-label chip-top">
                    <i class="bi bi-bar-chart"></i> Top 150
                </label>
                <InputNumber id="top150Input" @bind-Value="form.Top150"
                    class="@($"form-control form-control-sm {GetValidationClass(nameof(form.Top150))}")" />
                <ValidationMessage For="@(() => form.Top150)" />
            </div>

            <div class="classement-item">
                <label for="franceInput" class="chip-label chip-pays">
                    <i class="bi bi-flag"></i> France
                </label>
                <InputNumber id="franceInput" @bind-Value="form.France"
                    class="@($"form-control form-control-sm {GetValidationClass(nameof(form.France))}")" />
                <ValidationMessage For="@(() => form.France)" />
            </div>

        </div>
    </EditForm>

    <h4 class="section-title">Puissance (@PuissanceTotale)</h4>

    <div class="bloc-pieces-puissance-premium">

        <div class="puissance-zones">
            <div class="commandant-zone">
                <div class="label-premium">
                    <i class="bi bi-crown"></i> Commandant
                </div>
                <span class="pill-puissance-compact">@PuissanceCommandant</span>
            </div>

            <div class="mercenaires-zone">
                <div class="label-premium">
                    <i class="bi bi-people"></i> Mercenaires
                </div>
                <span class="pill-puissance-compact">@PuissanceMercenaires</span>
            </div>

            <div class="lucie-zone">
                <div class="label-premium">
                    <i class="bi bi-gems"></i> Pièces Lucie
                </div>
                <span class="pill-puissance-compact">@PuissanceLucie</span>
            </div>
        </div>

    </div>

    <h4 class="section-title">Personnages</h4>

    <div class="bloc-personnages-premium">

        <div class="collapse-toggle" @onclick="() => showPersonnages = !showPersonnages">
            <i class="bi bi-people-fill"></i>
            <span>Escouade</span>
            <i class="bi @(showPersonnages ? "bi-chevron-up" : "bi-chevron-down")" style="margin-left:auto;"></i>
        </div>

        @if (showPersonnages)
        {
            <div class="collapse-content">
                <div class="ligne-commandant-mercenaires">

                    <!-- Bloc Commandant -->
                    <div class="bloc-personnage-type bloc-commandant">
                        <h5 class="subsection-title">Commandant</h5>
                        <div class="mercenaires-grid">
                            <div class="personnage-card personnage-card-small">
                                <div class="card-header-row">
                                    <div class="card-rarity rarity-@Commandant.Rarete.ToString().ToLower()">
                                        @Commandant.Rarete
                                    </div>
                                    <div class="card-name">@Commandant.Nom</div>
                                </div>

                                <img src="@Commandant.GetImageUrl(true)" alt="@Commandant.Nom" class="card-image"
                                    onerror="this.onerror=null; this.src='/api/resources/interface/default_portrait.png';" />

                                <div class="card-info">
                                    <div>Niv: @Commandant.Niveau</div>
                                    <div class="card-stars">@TemplateEscouade.GetRankStars(Commandant.Rang)</div>
                                    <div>Puiss: @Commandant.Puissance</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bloc Mercenaires -->
                    <div class="bloc-personnage-type bloc-mercenaires">
                        <h5 class="subsection-title">Mercenaires</h5>
                        <div class="mercenaires-grid">
                            @foreach (var m in Mercenaires)
                            {
                                <div class="personnage-card personnage-card-small">
                                    <div class="card-header-row">
                                        <div class="card-rarity rarity-@m.Rarete.ToString().ToLower()">@m.Rarete</div>
                                        <div class="card-name">@m.Nom</div>
                                    </div>

                                    <img src="@m.GetImageUrl(true)" alt="@m.Nom" class="card-image"
                                        onerror="this.onerror=null; this.src='/api/resources/interface/default_portrait.png';" />

                                    <div class="card-info">
                                        <div>Niv: @m.Niveau</div>
                                        <div class="card-stars">@TemplateEscouade.GetRankStars(m.Rang)</div>
                                        <div>Puiss: @m.Puissance</div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Androïdes et Pièces sur la même ligne -->
                <div class="bloc-androides-et-pieces">
                    <!-- Androïdes -->
                    <div class="bloc-personnage-type bloc-androides">
                        <h5 class="subsection-title">Androïdes</h5>
                        <div class="androides-grid">
                            @foreach (var a in Androides)
                            {
                                <div class="personnage-card personnage-card-small">
                                    <div class="card-header-row">
                                        <div class="card-rarity rarity-@a.Rarete.ToString().ToLower()">@a.Rarete</div>
                                        <div class="card-name">@a.Nom</div>
                                    </div>

                                    <img src="@a.GetImageUrl(true)" alt="@a.Nom" class="card-image"
                                        onerror="this.onerror=null; this.src='/api/resources/interface/default_portrait.png';" />

                                    <div class="card-info">
                                        <div>Niv: @a.Niveau</div>
                                        <div class="card-stars">@TemplateEscouade.GetRankStars(a.Rang)</div>
                                        <div>Puiss: @a.Puissance</div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Pièces -->
                    <div class="bloc-personnage-type bloc-pieces">
                        <h5 class="subsection-title">Pièces</h5>
                        <div class="pieces-pills">
                            @foreach (var p in Pieces)
                            {
                                <span class="pill-piece">
                                    <span class="pill-piece-name">@p.Nom (Niv @p.Niveau)</span>
                                    <span class="pill-piece-power">@p.PuissanceLegacy</span>
                                </span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- FOOTER -->
<div class="modal-footer">
    <button type="submit" class="btn btn-success" disabled="@( !isValid )" form="classementForm">
        @(IsEdit ? "Mettre à jour" : "Créer")
    </button>
</div>

@code {
    private PersonnageHistorique Commandant { get; set; } = default!;
    private List<PersonnageHistorique> Mercenaires { get; set; } = new();
    private List<PersonnageHistorique> Androides { get; set; } = new();
    private List<PieceHistorique> Pieces { get; set; } = new();

    private readonly List<int> LigueSteps = Enumerable.Range(1, 25).Reverse().ToList();
    private const int EliteTop50Value = 50;

    private ClassementFormModel form = new();
    private EditContext? editContext;
    private bool isValid;
    private bool showPersonnages = true;
    private bool IsEdit => Existing != null;
    private int PuissanceTotale => IsEdit && Existing != null ? Existing.PuissanceTotale : PersonnageService.GetPuissanceEscouade();
    private int PuissanceCommandant { get; set; } = 0;
    private int PuissanceMercenaires { get; set; } = 0;
    private int PuissanceLucie { get; set; } = 0;

    [Parameter] public HistoriqueClassement? Existing { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    [Inject]
    public ApplicationDbContext DbContext { get; set; } = null!;

    protected override void OnParametersSet()
    {
        if (IsEdit && Existing != null)
        {
            form = new ClassementFormModel
            {
                DateEnregistrement = Existing.DateEnregistrement,
                Ligue = Existing.Ligue,
                Score = Existing.Score,
                Nutaku = Existing.Classements.FirstOrDefault(c => c.Type == TypeClassement.Nutaku)?.Valeur,
                Top150 = Existing.Classements.FirstOrDefault(c => c.Type == TypeClassement.Top150)?.Valeur,
                France = Existing.Classements.FirstOrDefault(c => c.Type == TypeClassement.France)?.Valeur
            };

            Commandant = Existing.Commandant ?? new PersonnageHistorique { Nom = "Aucun", Type = Server.Models.TypePersonnage.Commandant };
            Mercenaires = Existing.Mercenaires?.ToList() ?? new List<PersonnageHistorique>();
            Androides = Existing.Androides?.ToList() ?? new List<PersonnageHistorique>();
            Pieces = Existing.Pieces?.ToList() ?? new List<PieceHistorique>();
            
            // Charger les puissances historisées
            PuissanceCommandant = Existing.PuissanceCommandant;
            PuissanceMercenaires = Existing.PuissanceMercenaires;
            PuissanceLucie = Existing.PuissanceLucie;
        }
        else
        {
            form = new ClassementFormModel();
            form.DateEnregistrement = DateOnly.FromDateTime(DateTime.Now);

            var cmd = PersonnageService.GetCommandants(true).FirstOrDefault();
            Commandant = cmd != null ? new PersonnageHistorique
            {
                IdOrigine = cmd.Id,
                Nom = cmd.Nom,
                Niveau = cmd.Niveau,
                Rang = cmd.Rang,
                Rarete = cmd.Rarete,
                Puissance = cmd.Puissance,
                Type = cmd.Type,
                Capacites = cmd.Capacites,
            } : new PersonnageHistorique { Nom = "Aucun", Type = Server.Models.TypePersonnage.Commandant };

            Mercenaires = PersonnageService.GetMercenaires(true)?.Select(m => new PersonnageHistorique
            {
                IdOrigine = m.Id,
                Nom = m.Nom,
                Niveau = m.Niveau,
                Rang = m.Rang,
                Rarete = m.Rarete,
                Puissance = m.Puissance,
                Type = m.Type,
                Capacites = m.Capacites,
            }).ToList() ?? new List<PersonnageHistorique>();

            Androides = PersonnageService.GetAndroides(true)?.Select(a => new PersonnageHistorique
            {
                IdOrigine = a.Id,
                Nom = a.Nom,
                Niveau = a.Niveau,
                Rang = a.Rang,
                Rarete = a.Rarete,
                Puissance = a.Puissance,
                Type = a.Type,
                Capacites = a.Capacites,
            }).ToList() ?? new List<PersonnageHistorique>();

            Pieces = PersonnageService.GetPieces(true)?.Select(p => new PieceHistorique
            {
                IdOrigine = p.Id,
                Nom = p.Nom,
                Niveau = p.Niveau,
                Selectionnee = p.Selectionnee,
                AspectsStrategiques = p.AspectsStrategiques,
                AspectsTactiques = p.AspectsTactiques
            }).ToList() ?? new List<PieceHistorique>();
            
            // Calculer les puissances actuelles
            CalculerPuissances();
        }

        editContext = new EditContext(form);
        isValid = IsEdit ? editContext.Validate() : false;

        editContext.OnFieldChanged += (_, __) =>
        {
            isValid = editContext.Validate();
            InvokeAsync(StateHasChanged);
        };

        StateHasChanged();
    }

    private void CalculerPuissances()
    {
        // Puissance du commandant
        var cmdPuissance = Commandant?.Puissance ?? 0;
        var cmdRang = Commandant?.Rang ?? 0;
        PuissanceCommandant = cmdPuissance + (cmdRang * 20);
        
        // Puissance des mercenaires et androïdes
        PuissanceMercenaires = Mercenaires.Sum(m => m.Puissance) + Androides.Sum(a => a.Puissance);
        
        // Puissance des pièces Lucie - utiliser la méthode du service
        PuissanceLucie = PersonnageService.GetPuissanceLucieEscouade();
    }

    private void Reset()
    {
        form = new ClassementFormModel();
        editContext = new EditContext(form);
        isValid = false;
    }

    private async Task SaveClassement()
    {
        if (!isValid)
            return;

        if (IsEdit && Existing != null)
        {
            await HistoriqueClassementService.UpdateClassementEditableAsync(
                Existing.Id,
                form.DateEnregistrement,
                form.Ligue ?? 0,
                form.Score ?? 0,
                form.Nutaku ?? 0,
                form.Top150 ?? 0,
                form.France ?? 0);

            if (OnSaved.HasDelegate)
            {
                await OnSaved.InvokeAsync();
            }

            ModalService.Close();
            return;
        }

        HistoriqueClassement historique = new HistoriqueClassement
        {
            DateEnregistrement = form.DateEnregistrement,
            Ligue = form.Ligue ?? 0,
            Score = form.Score ?? 0,
            Classements = new List<Classement>(),
            Mercenaires = Mercenaires,
            Androides = Androides,
            Pieces = Pieces,
            Commandant = Commandant,
            PuissanceTotale = PersonnageService.GetPuissanceEscouade(),
            PuissanceCommandant = PuissanceCommandant,
            PuissanceMercenaires = PuissanceMercenaires,
            PuissanceLucie = PuissanceLucie
        };

        historique.Classements.Add(new Classement
        {
            Nom = "Classement Nutaku",
            Type = TypeClassement.Nutaku,
            Valeur = form.Nutaku ?? 0
        });

        historique.Classements.Add(new Classement
        {
            Nom = "Classement Top150",
            Type = TypeClassement.Top150,
            Valeur = form.Top150 ?? 0
        });

        historique.Classements.Add(new Classement
        {
            Nom = "Classement France",
            Type = TypeClassement.France,
            Valeur = form.France ?? 0
        });

        DbContext.HistoriquesClassement.Add(historique);
        await DbContext.SaveChangesAsync();

        Reset();

        if (OnSaved.HasDelegate)
        {
            await OnSaved.InvokeAsync();
        }

        ModalService.Close();
    }

    private string GetValidationClass(string fieldName)
    {
        if (editContext == null)
            return "";

        var fieldIdentifier = new FieldIdentifier(form, fieldName);
        bool hasErrors = editContext.GetValidationMessages(fieldIdentifier).Any();
        bool isModified = editContext.IsModified(fieldIdentifier);

        if (!isModified)
            return "";

        return hasErrors ? "is-invalid" : "is-valid";
    }
}
