@using CharacterManager.Components.Layout
@using CharacterManager
@using CharacterManager.Components
@using CharacterManager.Server.Services
@using CharacterManager.Server.Constants
@using Microsoft.AspNetCore.Components.Authorization
@using CharacterManager.Components.Modal


@inherits LayoutComponentBase

@inject AppVersionService VersionService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IModalService ModalService

<div class="layout-container @(railExpanded ? "rail-expanded" : "")">

    <!-- Navigation Rail -->
    <div class="nav-rail" @onmouseenter="() => railExpanded = true" @onmouseleave="() => railExpanded = false">

        <div class="nav-rail-header">
            <NavLink class="nav-rail-item nav-rail-home" href="/" Match="NavLinkMatch.All">
                <i class="bi bi-house-fill"></i>
                <span>
                    <LocalizedText Key="navigation.home" />
                </span>
            </NavLink>
        </div>

        <nav class="nav-rail-items">

            <NavLink class="nav-rail-item" href="escouade">
                <i class="bi bi-people-fill"></i>
                <span>
                    <LocalizedText Key="navigation.squad" />
                </span>
            </NavLink>

            <NavLink class="nav-rail-item" href="meilleur-escouade">
                <i class="bi bi-trophy-fill"></i>
                <span>
                    <LocalizedText Key="navigation.bestSquad" />
                </span>
            </NavLink>

            <NavLink class="nav-rail-item" href="inventaire">
                <i class="bi bi-collection-fill"></i>
                <span>
                    <LocalizedText Key="navigation.inventory" />
                </span>
            </NavLink>

            <NavLink class="nav-rail-item" href="templates">
                <i class="bi bi-layers-fill"></i>
                <span>
                    <LocalizedText Key="navigation.templates" />
                </span>
            </NavLink>

            <NavLink class="nav-rail-item" href="import-export-pml">
                <i class="bi bi-upload"></i>
                <span>
                    <LocalizedText Key="navigation.importExportPml" />
                </span>
            </NavLink>

            <NavLink class="nav-rail-item" href="historique">
                <i class="bi bi-graph-up"></i>
                <span>
                    <LocalizedText Key="navigation.rankings" />
                </span>
            </NavLink>

            <NavLink class="nav-rail-item" href="histoligues">
                <i class="bi bi-trophy"></i>
                <span>
                    <LocalizedText Key="navigation.leagueHistory" />
                </span>
            </NavLink>

            <NavLink class="nav-rail-item" href="maison-lucie">
                <i class="bi bi-house-fill"></i>
                <span>
                    <LocalizedText Key="navigation.lucieHouse" />
                </span>
            </NavLink>

            <AuthorizeView Roles="admin">
                <Authorized>
                    <NavLink class="nav-rail-item" href="admin/users">
                        <i class="bi bi-shield-lock-fill"></i>
                        <span>
                            <LocalizedText Key="navigation.manageUsers" />
                        </span>
                    </NavLink>
                </Authorized>
            </AuthorizeView>

        </nav>
    </div>

    <!-- Main content -->
    <main class="main-content">

        <div class="top-row">

            <!-- ZONE GAUCHE -->
            <div class="top-left">
                <span class="msr" @onclick="ShowAboutModal" title="À propos">info</span>

                <span class="msr" @onclick="ShowRoadmapModal" title="Feuille de route">flag</span>
                <span class="msr" @onclick="ShowChangelogModal" title="Notes de version">update</span>
                <span class="msr" @onclick="GoSettings" title="Paramètres">settings</span>

                <span class="badge">v @VersionService.GetAppVersion()</span>
            </div>

            <!-- ZONE DROITE -->
            <div class="top-right">
                <AuthorizeView>
                    <Authorized>
                        <span class="user-label">@userName</span>
                        @if (userRole == "admin")
                        {
                            <span class="role-badge admin">ADMIN</span>
                        }
                        <button class="logout-btn" @onclick="Logout">Logout</button>
                        <span class="lang-badge">@currentLanguage</span>
                    </Authorized>

                    <NotAuthorized>
                        <a class="login-btn" href="/login">Se connecter</a>
                    </NotAuthorized>
                </AuthorizeView>

            </div>

        </div>

        <article class="content px-4">
            <UpdateNotification />
            @Body
        </article>


    </main>

</div>

<ModalHost />

@code {
    private bool railExpanded = false;

    private bool isHomePage = false;

    [CascadingParameter]
    private Task<Microsoft.AspNetCore.Components.Authorization.AuthenticationState> AuthStateTask { get; set; } = default!;

    [Inject] private Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private Microsoft.AspNetCore.Authentication.IAuthenticationService AuthService { get; set; } = default!;

    [Inject]
    public ProfileService ProfileService { get; set; } = null!;

    private string userName = "";
    private string userRole = "";

    private void ShowAboutModal()
    {
        ModalService.Open<AboutModal>(size: ModalSize.Medium);
    }

    private void ShowRoadmapModal()
    {
        ModalService.Open<RoadmapModal>(size: ModalSize.XL);
    }

    private void ShowChangelogModal()
    {
        ModalService.Open<ChangelogModal>(size: ModalSize.XL);
    }

    private Profile? currentProfile;
    private string currentLanguage = AppConstants.Defaults.DefaultLanguage.ToUpper();

    protected override async Task OnInitializedAsync()
    {
        CheckIfHomePage();
        Navigation.LocationChanged += OnLocationChanged;

        // Load profile if authenticated
        var authState = await AuthStateTask;
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            var username = authState.User.Identity!.Name ?? "";
            currentProfile = await ProfileService.GetOrCreateAsync(username);
            currentLanguage = currentProfile.Language.ToUpper() ?? AppConstants.Defaults.DefaultLanguage.ToUpper();
            userRole = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "utilisateur";
        }

        await Task.CompletedTask;
    }

    protected override async Task OnParametersSetAsync()
    {
        var auth = await AuthStateTask;
        if (auth.User.Identity?.IsAuthenticated == true)
        {
            userName = auth.User.Identity!.Name ?? "";
            userRole = auth.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "utilisateur";
        }
        else
        {
            userName = "";
            userRole = "";
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        CheckIfHomePage();
        StateHasChanged();
    }

    private void CheckIfHomePage()
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath;
        isHomePage = path == "/" || path.EndsWith("/index.html");
    }

    public async ValueTask DisposeAsync()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        await ValueTask.CompletedTask;
    }

    private void Logout()
    {
        Navigation.NavigateTo("/api/logout", forceLoad: true);
    }

    private void GoSettings()
    {
        Navigation.NavigateTo("settings");
    }
}