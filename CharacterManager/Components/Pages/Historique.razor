@page "/historique"
@rendermode InteractiveServer
@using CharacterManager.Server.Models

<link rel="stylesheet" href="/Styles/Historique.css" />

<PageTitle>Historique des Escouades</PageTitle>

<div class="page-header-banner">
    <img src="/images/interface/menu-icon.png" alt="" class="page-header-icon" />
    <h1 class="page-title">HISTORIQUE DES ESCOUADES</h1>
</div>

<div class="historique-container">
    <div class="container-fluid mt-4 mb-4">
        <div class="controls-section mb-4">
            <div class="row">
                <div class="col-md-4">
                    <label for="dateDebut" class="form-label">Date de début:</label>
                    <input type="date" id="dateDebut" class="form-control" @bind="dateDebut" />
                </div>
                <div class="col-md-4">
                    <label for="dateFin" class="form-label">Date de fin:</label>
                    <input type="date" id="dateFin" class="form-control" @bind="dateFin" />
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button class="btn btn-primary" @onclick="FiltrerHistorique">Filtrer</button>
                    <button class="btn btn-secondary" @onclick="RinitialiserFiltres">Réinitialiser</button>
                    <button class="btn btn-danger" @onclick="ViderHistorique" title="Vider tout l'historique">Vider</button>
                </div>
            </div>
        </div>

        @if (historiques != null && historiques.Count > 0)
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover historique-table">
                    <thead class="table-dark">
                        <tr>
                            <th class="col-date">Date</th>
                            <th class="col-heure">Heure</th>
                            <th class="col-puissance">Puissance</th>
                            <th class="col-classement">Classement</th>
                            @for (int i = 1; i <= nbMercenairesMax; i++)
                            {
                                <th class="col-mercenaire">Mercenaire @i</th>
                                <th class="col-niveau">Niv</th>
                                <th class="col-rarete">Rareté</th>
                                <th class="col-puissance-pers">Puiss</th>
                            }
                            <th class="col-commandant">Commandant</th>
                            <th class="col-niveau">Niv</th>
                            <th class="col-rarete">Rareté</th>
                            <th class="col-puissance-pers">Puiss</th>
                            @for (int i = 1; i <= nbAndroidsMax; i++)
                            {
                                <th class="col-android">Androïde @i</th>
                                <th class="col-niveau">Niv</th>
                                <th class="col-rarete">Rareté</th>
                                <th class="col-puissance-pers">Puiss</th>
                            }
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var historique in historiques)
                        {
                            var donnees = HistoriqueService.DeserializerEscouade(historique.DonneesEscouadeJson);
                            if (donnees != null)
                            {
                                <tr>
                                    <td>@historique.DateEnregistrement:dd/MM/yyyy</td>
                                    <td>@historique.DateEnregistrement:HH:mm:ss</td>
                                    <td class="fw-bold">@historique.PuissanceTotal</td>
                                    <td>@(historique.Classement?.ToString() ?? "-")</td>

                                    @for (int i = 0; i < nbMercenairesMax; i++)
                                    {
                                        if (i < donnees.Mercenaires.Count)
                                        {
                                            var merc = donnees.Mercenaires[i];
                                            <td class="text-truncate" title="@merc.Nom">@merc.Nom</td>
                                            <td>@merc.Niveau</td>
                                            <td><span class="badge badge-rarity" data-rarity="@merc.Rarete">@merc.Rarete</span></td>
                                            <td>@merc.Puissance</td>
                                        }
                                        else
                                        {
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                        }
                                    }

                                    @if (donnees.Commandant != null)
                                    {
                                        <td class="text-truncate fw-bold" title="@donnees.Commandant.Nom">@donnees.Commandant.Nom</td>
                                        <td>@donnees.Commandant.Niveau</td>
                                        <td><span class="badge badge-rarity" data-rarity="@donnees.Commandant.Rarete">@donnees.Commandant.Rarete</span></td>
                                        <td>@donnees.Commandant.Puissance</td>
                                    }
                                    else
                                    {
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    }

                                    @for (int i = 0; i < nbAndroidsMax; i++)
                                    {
                                        if (i < donnees.Androides.Count)
                                        {
                                            var android = donnees.Androides[i];
                                            <td class="text-truncate" title="@android.Nom">@android.Nom</td>
                                            <td>@android.Niveau</td>
                                            <td><span class="badge badge-rarity" data-rarity="@android.Rarete">@android.Rarete</span></td>
                                            <td>@android.Puissance</td>
                                        }
                                        else
                                        {
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                        }
                                    }

                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => SupprimerEnregistrement(historique.Id))">Supprimer</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info" role="alert">
                Aucun historique trouvé. Commencez à créer des escouades pour remplir l'historique.
            </div>
        }
    </div>
</div>

