@page "/historique"
@using CharacterManager.Server.Constants
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using CharacterManager.Server.Models
@using CharacterManager.Components
@using CharacterManager.Components.Modal

<link rel="stylesheet" href="/css/Historique.css" />

<PageTitle><LocalizedText Key="history.title" /></PageTitle>

<div class="page-header-banner">
</div>

<div class="historique-container">
    <div class="container-fluid mt-4 mb-4">
        <div class="controls-section mb-4">
            <div class="row">
                <div class="col-md-4">
                    <label for="dateDebut" class="form-label"><LocalizedText Key="history.startDate" /></label>
                    <input type="date" id="dateDebut" class="form-control" @bind="dateDebut" />
                </div>
                <div class="col-md-4">
                    <label for="dateFin" class="form-label"><LocalizedText Key="history.endDate" /></label>
                    <input type="date" id="dateFin" class="form-control" @bind="dateFin" />
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2 flex-wrap">
                    <button class="btn btn-primary" @onclick="ShowCreerClassementModalAsync"><LocalizedText Key="history.create" /></button>
                    <button class="btn btn-primary" @onclick="FiltrerHistorique"><LocalizedText Key="history.filter" /></button>
                    <button class="btn btn-secondary" @onclick="ReinitialiserFiltres"><LocalizedText Key="history.reset" /></button>
                    <button class="btn btn-success" @onclick="ExporterHistorique" title=""><i class="bi bi-download"></i> <LocalizedText Key="history.export" /></button>
                    <button class="btn btn-info" @onclick="ImporterHistorique" title=""><i class="bi bi-upload"></i> <LocalizedText Key="history.import" /></button>
                    <button class="btn btn-danger" @onclick="ViderHistorique" title=""><LocalizedText Key="history.clear" /></button>
                </div>
            </div>
        </div>

        @if (historiques != null && historiques.Count > 0)
        {
            <div class="table-responsive">
                <table class="table table-hover historique-table">
                    <thead class="table-dark">
                        <tr>
                            <th class="col-date"><LocalizedText Key="history.table.date" /></th>
                            <th class="col-ligue"><LocalizedText Key="history.table.league" /></th>
                            <th class="col-score"><LocalizedText Key="history.table.score" /></th>
                            <th class="col-puissance"><LocalizedText Key="history.table.power" /></th>
                            <th class="col-classement"><LocalizedText Key="history.table.rank" /></th>
                            <th class="text-center"><LocalizedText Key="history.table.commander" /></th>
                            @for (int i = 1; i <= nbMercenairesMax; i++)
                            {
                                <th class="text-center"><LocalizedText Key="history.table.mercenary" /> @i</th>
                            }
                            @for (int i = 1; i <= nbAndroidsMax; i++)
                            {
                                <th class="text-center"><LocalizedText Key="history.table.android" /> @i</th>
                            }
                            <th class="col-lucie"><LocalizedText Key="history.table.lucie" /></th>
                            <th class="col-actions"><LocalizedText Key="history.table.actions" /></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var historique in historiques)
                        {
                                <tr>
                                    <td class="info-cell date-cell"><span class="pill pill-date">@historique.DateEnregistrement.ToString("dd/MM/yyyy")</span></td>
                                    <td class="info-cell ligue-cell"><span class="pill pill-ligue">@historique.Ligue</span></td>
                                    <td class="info-cell score-cell"><span class="pill pill-score">@historique.Score</span></td>
                                    <td class="info-cell puissance-cell"><span class="pill pill-puissance">@historique.PuissanceTotale</span></td>
                                    <td class="ranking-inline info-cell">
                                        <div class="chip chip-nutaku" title="Classement Nutaku (global)"><i class="bi bi-globe"></i><strong>Nutaku</strong> : @historique.Classements.FirstOrDefault(c => c.Type == TypeClassement.Nutaku)?.Valeur</div>
                                        <div class="chip chip-top" title="Classement Top 150"><i class="bi bi-trophy"></i><strong>Top 150</strong> : @historique.Classements.FirstOrDefault(c => c.Type == TypeClassement.Top150)?.Valeur</div>
                                        <div class="chip chip-pays" title="Classement par pays"><i class="bi bi-flag"></i><strong>Pays</strong> : @historique.Classements.FirstOrDefault(c => c.Type == TypeClassement.France)?.Valeur</div>
                                    </td>

                                        <td>
                                            <div class="personnage-card">
                                                <div class="card-header-row">
                                                    <div class="card-rarity rarity-@historique.Commandant?.Rarete.ToString().ToLower()">@historique.Commandant?.Rarete</div>
                                                    <div class="card-name">@historique.Commandant?.Nom</div>
                                                </div>
                                                <img src="@GetImageUrl(historique.Commandant?.Nom ?? string.Empty)" alt="@historique.Commandant?.Nom" class="card-image" onerror="this.onerror=null; this.src='/api/resources/interface/default_portrait.png';" />
                                                <div class="card-info">
                                                    <div>Niv: @historique.Commandant?.Niveau</div>
                                                    <div class="card-stars">@CharacterManager.Components.Pages.TemplateEscouade.GetRankStars(historique.Commandant?.Rang ?? 0)</div>
                                                    <div>Puiss: @historique.Commandant?.Puissance</div>
                                                </div>
                                            </div>
                                        </td>

                                    @for (int i = 0; i < nbMercenairesMax; i++)
                                    {
                                        if (i < historique.Mercenaires.Count)
                                        {
                                            var merc = historique.Mercenaires[i];
                                            <td>
                                                <div class="personnage-card">
                                                    <div class="card-header-row">
                                                        <div class="card-rarity rarity-@merc.Rarete.ToString().ToLower()">@merc.Rarete</div>
                                                        <div class="card-name">@merc.Nom</div>
                                                    </div>
                                                    <img src="@GetImageUrl(merc.Nom)" alt="@merc.Nom" class="card-image" onerror="this.onerror=null; this.src='/api/resources/interface/default_portrait.png';" />
                                                    <div class="card-info">
                                                        <div>Niv: @merc.Niveau</div>
                                                        <div class="card-stars">@CharacterManager.Components.Pages.TemplateEscouade.GetRankStars(merc.Rang)</div>
                                                        <div>Puiss: @merc.Puissance</div>
                                                    </div>
                                                </div>
                                            </td>
                                        }
                                        else
                                        {
                                            <td>-</td>
                                        }
                                    }

                                    @for (int i = 0; i < nbAndroidsMax; i++)
                                    {
                                        if (i < historique.Androides.Count)
                                        {
                                            var android = historique.Androides[i];
                                            <td>
                                                <div class="personnage-card">
                                                    <div class="card-header-row">
                                                        <div class="card-rarity rarity-@android.Rarete.ToString().ToLower()">@android.Rarete</div>
                                                        <div class="card-name">@android.Nom</div>
                                                    </div>
                                                    <img src="@GetImageUrl(android.Nom)" alt="@android.Nom" class="card-image" onerror="this.onerror=null; this.src='/api/resources/interface/default_portrait.png';" />
                                                    <div class="card-info">
                                                        <div>Niv: @android.Niveau</div>
                                                        <div>Puiss: @android.Puissance</div>
                                                    </div>
                                                </div>
                                            </td>
                                        }
                                        else
                                        {
                                            <td>-</td>
                                        }
                                    }

                                    <td class="lucie-cell">
                                        @if (historique.Pieces?.Any() == true)
                                        {
                                            <div class="lucie-pills">
                                                @foreach (var piece in historique.Pieces)
                                                {
                                                    <div class="lucie-pill" title="Puissance @piece.PuissanceLegacy">
                                                        <div class="lucie-pill-header">
                                                            <span class="lucie-pill-name">@piece.Nom</span>
                                                            <span class="lucie-pill-level">Niv @piece.Niveau</span>
                                                        </div>
                                                        <span class="lucie-pill-power">@piece.PuissanceLegacy</span>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="pill pill-puissance">Aucune pièce</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-warning" @onclick="@(() => EditEnregistrement(historique))" title="">
                                                <i class="bi bi-pencil-square"></i> Éditer
                                            </button>
                                            <button class="btn btn-sm btn-danger" @onclick="@(() => SupprimerEnregistrement(historique.Id))" title="">
                                                <i class="bi bi-trash"></i> <LocalizedText Key="common.delete" />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info" role="alert">
                <LocalizedText Key="history.empty" />
            </div>
        }
    </div>
</div>

<InputFile id="historiqueFileInput" @ref="inputFileRef" OnChange="HandleFileSelected" accept=".pml" style="display:none;" />


