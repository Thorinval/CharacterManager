@page "/historique"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using CharacterManager.Server.Models
@using CharacterManager.Components

<link rel="stylesheet" href="/Styles/Historique.css" />

<PageTitle><LocalizedText Key="history.title" /></PageTitle>

<div class="page-header-banner">
    <img src="/images/interface/menu-icon.png" alt="" class="page-header-icon" />
    <h1 class="page-title"><LocalizedText Key="history.pageTitle" /></h1>
</div>

<div class="historique-container">
    <div class="container-fluid mt-4 mb-4">
        <div class="controls-section mb-4">
            <div class="row">
                <div class="col-md-4">
                    <label for="dateDebut" class="form-label"><LocalizedText Key="history.startDate" /></label>
                    <input type="date" id="dateDebut" class="form-control" @bind="dateDebut" />
                </div>
                <div class="col-md-4">
                    <label for="dateFin" class="form-label"><LocalizedText Key="history.endDate" /></label>
                    <input type="date" id="dateFin" class="form-control" @bind="dateFin" />
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2 flex-wrap">
                    <button class="btn btn-primary" @onclick="FiltrerHistorique"><LocalizedText Key="history.filter" /></button>
                    <button class="btn btn-secondary" @onclick="RinitialiserFiltres"><LocalizedText Key="history.reset" /></button>
                    <button class="btn btn-success" @onclick="ExporterHistorique" title=""><i class="bi bi-download"></i> <LocalizedText Key="history.exportXml" /></button>
                    <button class="btn btn-info" @onclick="ImporterHistorique" title=""><i class="bi bi-upload"></i> <LocalizedText Key="history.importXml" /></button>
                    <button class="btn btn-danger" @onclick="ViderHistorique" title=""><LocalizedText Key="history.clear" /></button>
                </div>
            </div>
        </div>

        @if (historiques != null && historiques.Count > 0)
        {
            <div class="table-responsive">
                <table class="table table-hover historique-table">
                    <thead class="table-dark">
                        <tr>
                            <th class="col-date"><LocalizedText Key="history.table.date" /></th>
                            <th class="col-ligue"><LocalizedText Key="history.table.league" /></th>
                            <th class="col-score"><LocalizedText Key="history.table.score" /></th>
                            <th class="col-puissance"><LocalizedText Key="history.table.power" /></th>
                            <th class="col-classement"><LocalizedText Key="history.table.rank" /></th>
                            <th class="text-center"><LocalizedText Key="history.table.commander" /></th>
                            @for (int i = 1; i <= nbMercenairesMax; i++)
                            {
                                <th class="text-center"><LocalizedText Key="history.table.mercenary" /> @i</th>
                            }
                            @for (int i = 1; i <= nbAndroidsMax; i++)
                            {
                                <th class="text-center"><LocalizedText Key="history.table.android" /> @i</th>
                            }
                            <th class="col-lucie"><LocalizedText Key="history.table.lucie" /></th>
                            <th class="col-actions"><LocalizedText Key="history.table.actions" /></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var historique in historiques)
                        {
                            var donnees = HistoriqueService.DeserializerEscouade(historique.DonneesEscouadeJson);
                            if (donnees != null)
                            {
                                <tr>
                                    <td class="info-cell date-cell"><span class="pill pill-date">@historique.DateEnregistrement.ToString("dd/MM/yyyy")</span></td>
                                    <td class="info-cell ligue-cell"><span class="pill pill-ligue">@donnees.Ligue</span></td>
                                    <td class="info-cell score-cell"><span class="pill pill-score">@donnees.Score</span></td>
                                    <td class="info-cell puissance-cell"><span class="pill pill-puissance">@historique.PuissanceTotal</span></td>
                                    <td class="ranking-inline info-cell">
                                        <div class="chip chip-nutaku" title="Classement Nutaku (global)"><i class="bi bi-globe"></i><strong>Nutaku</strong> : @donnees.Nutaku</div>
                                        <div class="chip chip-top" title="Classement Top 150"><i class="bi bi-trophy"></i><strong>Top 150</strong> : @donnees.Top150</div>
                                        <div class="chip chip-pays" title="Classement par pays"><i class="bi bi-flag"></i><strong>Pays</strong> : @donnees.Pays</div>
                                    </td>

                                    @if (donnees.Commandant != null)
                                    {
                                        <td>
                                            <div class="personnage-card">
                                                <div class="card-header-row">
                                                    <div class="card-rarity rarity-@donnees.Commandant.Rarete.ToLower()">@donnees.Commandant.Rarete</div>
                                                    <div class="card-name">@donnees.Commandant.Nom</div>
                                                </div>
                                                <img src="@GetImageUrl(donnees.Commandant.Nom)" alt="@donnees.Commandant.Nom" class="card-image" onerror="this.onerror=null; this.src='/images/interface/default_portrait.png';" />
                                                <div class="card-info">
                                                    <div>Niv: @donnees.Commandant.Niveau</div>
                                                    <div class="card-stars">@RenderStars(donnees.Commandant.Rang)</div>
                                                    <div>Puiss: @donnees.Commandant.Puissance</div>
                                                </div>
                                            </div>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>-</td>
                                    }

                                    @for (int i = 0; i < nbMercenairesMax; i++)
                                    {
                                        if (i < donnees.Mercenaires.Count)
                                        {
                                            var merc = donnees.Mercenaires[i];
                                            <td>
                                                <div class="personnage-card">
                                                    <div class="card-header-row">
                                                        <div class="card-rarity rarity-@merc.Rarete.ToLower()">@merc.Rarete</div>
                                                        <div class="card-name">@merc.Nom</div>
                                                    </div>
                                                    <img src="@GetImageUrl(merc.Nom)" alt="@merc.Nom" class="card-image" onerror="this.onerror=null; this.src='/images/interface/default_portrait.png';" />
                                                    <div class="card-info">
                                                        <div>Niv: @merc.Niveau</div>
                                                        <div class="card-stars">@RenderStars(merc.Rang)</div>
                                                        <div>Puiss: @merc.Puissance</div>
                                                    </div>
                                                </div>
                                            </td>
                                        }
                                        else
                                        {
                                            <td>-</td>
                                        }
                                    }

                                    @for (int i = 0; i < nbAndroidsMax; i++)
                                    {
                                        if (i < donnees.Androides.Count)
                                        {
                                            var android = donnees.Androides[i];
                                            <td>
                                                <div class="personnage-card">
                                                    <div class="card-header-row">
                                                        <div class="card-rarity rarity-@android.Rarete.ToLower()">@android.Rarete</div>
                                                        <div class="card-name">@android.Nom</div>
                                                    </div>
                                                    <img src="@GetImageUrl(android.Nom)" alt="@android.Nom" class="card-image" onerror="this.onerror=null; this.src='/images/interface/default_portrait.png';" />
                                                    <div class="card-info">
                                                        <div>Niv: @android.Niveau</div>
                                                        <div>Puiss: @android.Puissance</div>
                                                    </div>
                                                </div>
                                            </td>
                                        }
                                        else
                                        {
                                            <td>-</td>
                                        }
                                    }

                                    <td>
                                        <span class="label">Puiss:</span> @donnees.LuciePuissance
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-danger" @onclick="@(() => SupprimerEnregistrement(historique.Id))" title="">
                                                <i class="bi bi-trash"></i> <LocalizedText Key="common.delete" />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info" role="alert">
                <LocalizedText Key="history.empty" />
            </div>
        }
    </div>
</div>

<InputFile id="historiqueFileInput" @ref="inputFileRef" OnChange="HandleFileSelected" accept=".xml" style="display:none;" />

