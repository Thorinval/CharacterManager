@page "/import-csv"
@using CharacterManager.Services
@using System.IO
@inject CsvImportService CsvImportService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<div class="page-header-banner">
    <h1 class="page-title">IMPORT CSV</h1>
    <p class="page-subtitle">Importer des personnages depuis un fichier CSV</p>
</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Importer des personnages (CSV)</h5>
                </div>
                <div class="card-body">
                    @if (importComplete)
                    {
                        <div class="alert @(importResult?.IsSuccess == true ? "alert-success" : "alert-danger")" role="alert">
                            @if (importResult?.IsSuccess == true)
                            {
                                <h4 class="alert-heading">Import réussi! ✓</h4>
                                <p>@importResult.SuccessCount personnage(s) importé(s) ou mis à jour.</p>
                                @if (importResult.Errors.Count > 0)
                                {
                                    <hr>
                                    <p><strong>Avertissements:</strong></p>
                                    <ul>
                                        @foreach (var error in importResult.Errors)
                                        {
                                            <li>@error</li>
                                        }
                                    </ul>
                                }
                            }
                            else
                            {
                                <h4 class="alert-heading">Erreur lors de l'import ✗</h4>
                                <p>@importResult?.Error</p>
                            }
                        </div>

                        <button class="btn btn-primary" @onclick="Reset">Nouvel import</button>
                        <a href="/inventaire" class="btn btn-secondary btn-retour">
                            <img src="/images/btn_retour.png" alt="Retour" class="btn-retour-icon" onerror="this.style.display='none';" />
                            <span>Retour à l'inventaire</span>
                        </a>
                    }
                    else
                    {
                        <form @onsubmit="HandleImport">
                            @if (!string.IsNullOrEmpty(lastImportedFileName))
                            {
                                <div class="alert alert-secondary">
                                    <strong>Dernier fichier importé:</strong> @lastImportedFileName
                                    @if (lastImportedFileName != null)
                                    {
                                        <small class="d-block text-muted mt-1">Vous pouvez sélectionner le même fichier ou en choisir un autre ci-dessous</small>
                                    }
                                </div>
                            }
                            
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Sélectionner un fichier CSV</label>
                                <InputFile 
                                    class="form-control" 
                                    id="csvFile" 
                                    accept=".csv" 
                                    OnChange="@OnFileSelected"
                                    disabled="@isImporting" />
                                <small class="text-muted">
                                    Format attendu: Personnage;Rareté;Type;Puissance;PA;PV;Action;Role;Niveau;Rang;Selection;Faction
                                </small>
                            </div>

                            <div class="mb-3">
                                <p class="text-info">
                                    <strong>Information:</strong>
                                </p>
                                <ul>
                                    <li>Les personnages existants seront mis à jour</li>
                                    <li>Les nouveaux personnages seront créés</li>
                                    <li>La colonne "Personnage" est utilisée comme identifiant unique</li>
                                    <li>Les séparateurs: point-virgule (;)</li>
                                </ul>
                            </div>

                            @if (selectedFileName != null)
                            {
                                <div class="alert alert-info">
                                    Fichier sélectionné: <strong>@selectedFileName</strong>
                                </div>
                            }

                            <button type="submit" class="btn btn-success" disabled="@(selectedFile == null || isImporting)">
                                @if (isImporting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Importation en cours...</span>
                                }
                                else
                                {
                                    <span>Importer</span>
                                }
                            </button>
                        </form>

                        <hr class="my-4" />
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h5 class="mb-0">Format CSV</h5>
                </div>
                <div class="card-body">
                    <p><strong>Colonnes requises:</strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Personnage (nom unique)</li>
                        <li>Rareté (R, SR, SSR)</li>
                        <li>Type (Mercenaire, Commandant, Androïde)</li>
                        <li>Puissance</li>
                        <li>PA (Points d'attaque)</li>
                        <li>PV (Points de vie)</li>
                        <li>Action</li>
                        <li>Role</li>
                        <li>Niveau</li>
                        <li>Rang</li>
                        <li>Selection (Oui/Non)</li>
                        <li>Faction</li>
                    </ul>

                    <p class="mt-3"><strong>Factions:</strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Syndicat</li>
                        <li>Pacificateurs</li>
                        <li>Hommes libres</li>
                    </ul>

                    <p class="mt-3"><strong>Rôles:</strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Sentinelle</li>
                        <li>Combattante</li>
                        <li>Androïde</li>
                        <li>Commandant</li>
 </ul>
                     <p class="mt-3"><strong>Action:</strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Mêlée</li>
                        <li>Distance</li>
                        <li>Androïde</li>
                        <li>Commandant</li>
                    </ul>                  

                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private bool isImporting = false;
    private bool importComplete = false;
    private ImportResult? importResult;
    private string? lastImportedFileName;

    protected override async Task OnInitializedAsync()
    {
        lastImportedFileName = await CsvImportService.GetLastImportedFileName();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
    }

    private async Task HandleImport()
    {
        if (selectedFile == null)
            return;

        isImporting = true;

        try
        {
            using (var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)) // 10MB max
            {
                importResult = await CsvImportService.ImportCsvAsync(stream, selectedFileName ?? "");
                importComplete = true;
                
                // Rafraîchir le nom du dernier fichier importé
                lastImportedFileName = await CsvImportService.GetLastImportedFileName();
            }
        }
        catch (Exception ex)
        {
            importResult = new ImportResult 
            { 
                IsSuccess = false, 
                Error = $"Erreur: {ex.Message}" 
            };
            importComplete = true;
        }
        finally
        {
            isImporting = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void Reset()
    {
        selectedFile = null;
        selectedFileName = null;
        importComplete = false;
        importResult = null;
    }
}
