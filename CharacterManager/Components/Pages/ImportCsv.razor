@page "/import-csv"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using CharacterManager.Server.Services
@using System.IO
@rendermode InteractiveServer
@using CharacterManager.Components

<div class="page-header-banner">
    <img src="/images/interface/menu-icon.png" alt="" class="page-header-icon" />
    <h1 class="page-title"><LocalizedText Key="importCsv.title" /></h1>
    <p class="page-subtitle"><LocalizedText Key="importCsv.subtitle" /></p>
</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><LocalizedText Key="importCsv.cardTitle" /></h5>
                </div>
                <div class="card-body">
                    @if (importComplete)
                    {
                        <div class="alert @(importResult?.IsSuccess == true ? "alert-success" : "alert-danger")" role="alert">
                            @if (importResult?.IsSuccess == true)
                            {
                                <h4 class="alert-heading"><LocalizedText Key="importCsv.success" /></h4>
                                <p>@importResult.SuccessCount <LocalizedText Key="importCsv.imported" /></p>
                                @if (importResult.Errors.Count > 0)
                                {
                                    <hr>
                                    <p><strong><LocalizedText Key="importCsv.warnings" /></strong></p>
                                    <ul>
                                        @foreach (var error in importResult.Errors)
                                        {
                                            <li>@error</li>
                                        }
                                    </ul>
                                }
                            }
                            else
                            {
                                <h4 class="alert-heading"><LocalizedText Key="importCsv.error" /></h4>
                                <p>@importResult?.Error</p>
                            }
                        </div>

                        <button class="btn btn-primary" @onclick="Reset"><LocalizedText Key="importCsv.newImport" /></button>
                        <a href="/inventaire" class="btn btn-secondary btn-retour" title="">
                            <img src="/images/btn_retour.png" alt="Retour" class="btn-retour-icon" onerror="this.style.display='none';" />
                        </a>
                    }
                    else
                    {
                        <form @onsubmit="HandleImport">
                            @if (!string.IsNullOrEmpty(lastImportedFileName))
                            {
                                <div class="alert alert-secondary">
                                    <strong><LocalizedText Key="importCsv.lastFile" /></strong> @lastImportedFileName
                                    @if (lastImportedFileName != null)
                                    {
                                        <small class="d-block text-muted mt-1"><LocalizedText Key="importCsv.selectInfo" /></small>
                                    }
                                </div>
                            }
                            
                            <div class="mb-3">
                                <label for="csvFile" class="form-label"><LocalizedText Key="importCsv.selectFile" /></label>
                                <InputFile 
                                    class="form-control" 
                                    id="csvFile" 
                                    accept=".csv" 
                                    OnChange="@OnFileSelected"
                                    disabled="@isImporting" />
                                <small class="text-muted">
                                    <LocalizedText Key="importCsv.expectedFormat" />
                                </small>
                            </div>

                            <div class="mb-3">
                                <p class="text-info">
                                    <strong><LocalizedText Key="importCsv.infoTitle" /></strong>
                                </p>
                                <ul>
                                    <li><LocalizedText Key="importCsv.infoUpdate" /></li>
                                    <li><LocalizedText Key="importCsv.infoCreate" /></li>
                                    <li><LocalizedText Key="importCsv.infoKey" /></li>
                                    <li><LocalizedText Key="importCsv.infoSeparator" /></li>
                                </ul>
                            </div>

                            @if (selectedFileName != null)
                            {
                                <div class="alert alert-info">
                                    <LocalizedText Key="importCsv.selectedFile" /> <strong>@selectedFileName</strong>
                                </div>
                            }

                            <button type="submit" class="btn btn-success" disabled="@(selectedFile == null || isImporting)">
                                @if (isImporting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span><LocalizedText Key="importCsv.importing" /></span>
                                }
                                else
                                {
                                    <span><LocalizedText Key="importCsv.import" /></span>
                                }
                            </button>
                        </form>

                        <hr class="my-4" />
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h5 class="mb-0"><LocalizedText Key="importCsv.format" /></h5>
                </div>
                <div class="card-body">
                    <p><strong><LocalizedText Key="importCsv.requiredColumns" /></strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Personnage (nom unique)</li>
                        <li>Rareté (R, SR, SSR)</li>
                        <li>Type (Mercenaire, Commandant, Androïde)</li>
                        <li>Puissance</li>
                        <li>PA (Points d'attaque)</li>
                        <li>PV (Points de vie)</li>
                        <li>Action</li>
                        <li>Role</li>
                        <li>Niveau</li>
                        <li>Rang</li>
                        <li>Selection (Oui/Non)</li>
                        <li>Faction</li>
                    </ul>

                    <p class="mt-3"><strong><LocalizedText Key="importCsv.factions" /></strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Syndicat</li>
                        <li>Pacificateurs</li>
                        <li>Hommes libres</li>
                    </ul>

                    <p class="mt-3"><strong><LocalizedText Key="importCsv.roles" /></strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Sentinelle</li>
                        <li>Combattante</li>
                        <li>Androïde</li>
                        <li>Commandant</li>
 </ul>
                     <p class="mt-3"><strong><LocalizedText Key="importCsv.actions" /></strong></p>
                    <ul style="font-size: 0.9rem;">
                        <li>Mêlée</li>
                        <li>Distance</li>
                        <li>Androïde</li>
                        <li>Commandant</li>
                    </ul>                  

                </div>
            </div>
        </div>
    </div>
</div>

