@page "/login"
@using Microsoft.AspNetCore.Components.Web
@using CharacterManager.Server.Services
@inject NavigationManager Nav
@inject ClientLocalizationService LocalizationService

<PageTitle><LocalizedText Key="login.title" /></PageTitle>

<div class="container mt-5" style="max-width: 420px;">
    <h2><LocalizedText Key="login.heading" /></h2>
    <div class="card p-3 mt-3">
        <form method="post" action="/api/login">
            <div class="mb-3">
                <label class="form-label"><LocalizedText Key="login.username" /></label>
                <input class="form-control" name="username" autocomplete="username" required />
            </div>
            <div class="mb-3">
                <label class="form-label"><LocalizedText Key="login.password" /></label>
                <input class="form-control" type="password" name="password" autocomplete="current-password" required />
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }
            <button class="btn btn-primary" type="submit"><LocalizedText Key="login.submit" /></button>
        </form>
    </div>
</div>

@code {
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        // Check for error query parameters
        var uri = new Uri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var error = query["error"];
        
        if (!string.IsNullOrEmpty(error))
        {
            errorMessage = error switch
            {
                "required" => LocalizationService.T("login.error.required"),
                "invalid" => LocalizationService.T("login.error.invalid"),
                "locked" => string.Format(LocalizationService.T("login.error.locked"), query["minutes"]),
                _ => LocalizationService.T("login.error.default")
            };
        }
    }
}
