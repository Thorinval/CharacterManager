@page "/login"
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Nav

<div class="container mt-5" style="max-width: 420px;">
    <h2>Connexion</h2>
    <div class="card p-3 mt-3">
        <form method="post" action="/api/login">
            <div class="mb-3">
                <label class="form-label">Nom d'utilisateur</label>
                <input class="form-control" name="username" autocomplete="username" required />
            </div>
            <div class="mb-3">
                <label class="form-label">Mot de passe</label>
                <input class="form-control" type="password" name="password" autocomplete="current-password" required />
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }
            <button class="btn btn-primary" type="submit">Se connecter</button>
        </form>
    </div>
</div>

@code {
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        // Check for error query parameters
        var uri = new Uri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var error = query["error"];
        
        if (!string.IsNullOrEmpty(error))
        {
            errorMessage = error switch
            {
                "required" => "Nom d'utilisateur et mot de passe requis",
                "invalid" => "Nom d'utilisateur ou mot de passe invalide",
                "locked" => $"Compte verrouillé. Réessayez dans {query["minutes"]} minutes",
                _ => "Erreur de connexion"
            };
        }
    }
}
