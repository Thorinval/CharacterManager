@page "/profile/password"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using CharacterManager.Server.Services
@inject ProfileService ProfileService
@inject NavigationManager Nav
@inject IHttpContextAccessor Http
@inject ClientLocalizationService LocalizationService

<PageTitle><LocalizedText Key="changePassword.title" /></PageTitle>

<AuthorizeView>
    <Authorized Context="auth">
        <div class="container mt-4" style="max-width:600px;">
            <h2><LocalizedText Key="changePassword.heading" /></h2>
            <div class="card p-3 mt-3">
                <EditForm Model="@this" OnValidSubmit="ChangePass" FormName="changePasswordForm">
                    <div class="mb-2">
                        <label class="form-label"><LocalizedText Key="changePassword.currentPassword" /></label>
                        <InputText class="form-control" type="password" @bind-Value="currentPassword" autocomplete="current-password" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label"><LocalizedText Key="changePassword.newPassword" /></label>
                        <InputText class="form-control" type="password" @bind-Value="newPassword" @oninput="ValidatePasswordLive" autocomplete="new-password" />
                    @if (passwordValidationErrors.Any())
                    {
                        <div class="mt-2">
                            <small class="text-muted"><LocalizedText Key="changePassword.requirementsTitle" /></small>
                            <ul class="small mb-0">
                                <li class="@(newPassword.Length >= 8 ? "text-success" : "text-danger")"><LocalizedText Key="changePassword.requirementMinLength" /></li>
                                <li class="@(newPassword.Any(char.IsUpper) ? "text-success" : "text-danger")"><LocalizedText Key="changePassword.requirementUpper" /></li>
                                <li class="@(newPassword.Any(char.IsLower) ? "text-success" : "text-danger")"><LocalizedText Key="changePassword.requirementLower" /></li>
                                <li class="@(newPassword.Any(char.IsDigit) ? "text-success" : "text-danger")"><LocalizedText Key="changePassword.requirementDigit" /></li>
                                <li class="@(newPassword.Any(ch => !char.IsLetterOrDigit(ch)) ? "text-success" : "text-danger")"><LocalizedText Key="changePassword.requirementSpecial" /></li>
                            </ul>
                        </div>
                    }
                    </div>
                    <div class="mb-2">
                        <label class="form-label"><LocalizedText Key="changePassword.confirmPassword" /></label>
                        <InputText class="form-control" type="password" @bind-Value="confirmPassword" autocomplete="new-password" />
                    </div>
                    <button class="btn btn-primary" type="submit"><LocalizedText Key="changePassword.submit" /></button>
                    <span class="text-muted ms-2">@message</span>
                </EditForm>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container mt-4"><LocalizedText Key="changePassword.signInPrompt" /></div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [SupplyParameterFromForm]
    private string currentPassword { get; set; } = string.Empty;
    
    [SupplyParameterFromForm]
    private string newPassword { get; set; } = string.Empty;
    
    [SupplyParameterFromForm]
    private string confirmPassword { get; set; } = string.Empty;
    private string message = string.Empty;
    private List<string> passwordValidationErrors = new List<string>();

    private void ValidatePasswordLive(ChangeEventArgs e)
    {
        newPassword = e.Value?.ToString() ?? string.Empty;
        passwordValidationErrors.Clear();
        
        if (newPassword.Length < 8) passwordValidationErrors.Add("min8");
        if (!newPassword.Any(char.IsUpper)) passwordValidationErrors.Add("upper");
        if (!newPassword.Any(char.IsLower)) passwordValidationErrors.Add("lower");
        if (!newPassword.Any(char.IsDigit)) passwordValidationErrors.Add("digit");
        if (!newPassword.Any(ch => !char.IsLetterOrDigit(ch))) passwordValidationErrors.Add("special");
    }

    private async Task ChangePass()
    {
        if (newPassword != confirmPassword) { message = LocalizationService.T("changePassword.messageMismatch"); return; }
        
        var strength = ProfileService.ValidatePasswordStrength(newPassword);
        if (!strength.ok) { message = string.Format(LocalizationService.T("changePassword.messageWeak"), strength.error); return; }
        
        var user = Http.HttpContext!.User.Identity!.Name ?? string.Empty;
        var prof = await ProfileService.GetByUsernameAsync(user);
        if (prof == null) { message = LocalizationService.T("changePassword.messageUserNotFound"); return; }
        if (!ProfileService.VerifyPassword(prof, currentPassword)) { message = LocalizationService.T("changePassword.messageInvalidCurrent"); return; }
        var ok = await ProfileService.ChangePasswordAsync(user, newPassword);
        message = ok ? LocalizationService.T("changePassword.messageSuccess") : LocalizationService.T("changePassword.messageError");
        if (ok) { currentPassword = newPassword = confirmPassword = string.Empty; passwordValidationErrors.Clear(); }
    }
}
