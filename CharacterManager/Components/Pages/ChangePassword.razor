@page "/profile/password"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using CharacterManager.Server.Services
@inject ProfileService ProfileService
@inject NavigationManager Nav
@inject IHttpContextAccessor Http

<AuthorizeView>
    <Authorized Context="auth">
        <div class="container mt-4" style="max-width:600px;">
            <h2>Changer le mot de passe</h2>
            <div class="card p-3 mt-3">
                <EditForm Model="@this" OnValidSubmit="ChangePass" FormName="changePasswordForm">
                    <div class="mb-2">
                        <label class="form-label">Mot de passe actuel</label>
                        <InputText class="form-control" type="password" @bind-Value="currentPassword" autocomplete="current-password" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Nouveau mot de passe</label>
                        <InputText class="form-control" type="password" @bind-Value="newPassword" @oninput="ValidatePasswordLive" autocomplete="new-password" />
                    @if (passwordValidationErrors.Any())
                    {
                        <div class="mt-2">
                            <small class="text-muted">Exigences du mot de passe:</small>
                            <ul class="small mb-0">
                                <li class="@(newPassword.Length >= 8 ? "text-success" : "text-danger")">Au moins 8 caractères</li>
                                <li class="@(newPassword.Any(char.IsUpper) ? "text-success" : "text-danger")">Au moins une majuscule</li>
                                <li class="@(newPassword.Any(char.IsLower) ? "text-success" : "text-danger")">Au moins une minuscule</li>
                                <li class="@(newPassword.Any(char.IsDigit) ? "text-success" : "text-danger")">Au moins un chiffre</li>
                                <li class="@(newPassword.Any(ch => !char.IsLetterOrDigit(ch)) ? "text-success" : "text-danger")">Au moins un caractère spécial</li>
                            </ul>
                        </div>
                    }
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Confirmer</label>
                        <InputText class="form-control" type="password" @bind-Value="confirmPassword" autocomplete="new-password" />
                    </div>
                    <button class="btn btn-primary" type="submit">Mettre à jour</button>
                    <span class="text-muted ms-2">@message</span>
                </EditForm>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container mt-4">Veuillez vous connecter.</div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [SupplyParameterFromForm]
    private string currentPassword { get; set; } = string.Empty;
    
    [SupplyParameterFromForm]
    private string newPassword { get; set; } = string.Empty;
    
    [SupplyParameterFromForm]
    private string confirmPassword { get; set; } = string.Empty;
    private string message = string.Empty;
    private List<string> passwordValidationErrors = new List<string>();

    private void ValidatePasswordLive(ChangeEventArgs e)
    {
        newPassword = e.Value?.ToString() ?? string.Empty;
        passwordValidationErrors.Clear();
        
        if (newPassword.Length < 8) passwordValidationErrors.Add("min8");
        if (!newPassword.Any(char.IsUpper)) passwordValidationErrors.Add("upper");
        if (!newPassword.Any(char.IsLower)) passwordValidationErrors.Add("lower");
        if (!newPassword.Any(char.IsDigit)) passwordValidationErrors.Add("digit");
        if (!newPassword.Any(ch => !char.IsLetterOrDigit(ch))) passwordValidationErrors.Add("special");
    }

    private async Task ChangePass()
    {
        if (newPassword != confirmPassword) { message = "Les mots de passe ne correspondent pas"; return; }
        
        var strength = ProfileService.ValidatePasswordStrength(newPassword);
        if (!strength.ok) { message = $"Mot de passe faible: {strength.error}"; return; }
        
        var user = Http.HttpContext!.User.Identity!.Name ?? string.Empty;
        var prof = await ProfileService.GetByUsernameAsync(user);
        if (prof == null) { message = "Utilisateur introuvable"; return; }
        if (!ProfileService.VerifyPassword(prof, currentPassword)) { message = "Mot de passe actuel invalide"; return; }
        var ok = await ProfileService.ChangePasswordAsync(user, newPassword);
        message = ok ? "Mot de passe mis à jour" : "Erreur de mise à jour";
        if (ok) { currentPassword = newPassword = confirmPassword = string.Empty; passwordValidationErrors.Clear(); }
    }
}
