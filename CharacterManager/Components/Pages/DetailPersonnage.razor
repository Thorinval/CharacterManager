@page "/detail-personnage/{id:int}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject PersonnageService PersonnageService
@inject NavigationManager Navigation
@using CharacterManager.Server.Models
@using CharacterManager.Server.Services
@using System
@using System.Linq
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@rendermode InteractiveServer

<link rel="stylesheet" href="/Styles/DetailPersonnage.css" />

<PageTitle>@(currentPerso?.Nom ?? "Détail Personnage")</PageTitle>

@if (currentPerso != null)
{
    <div class="page-header-banner">
        <a @onclick="GoBack" @onclick:preventDefault="true" class="back-button" aria-label="Retour" title="Retour">
            <img src="/images/interface/btn_retour.png" alt="Retour" class="btn-retour-icon" />
        </a>
        <h1 class="page-title">@currentPerso.Nom</h1>
        @if (!isEditing)
        {
            <button @onclick="EnterEditMode" class="btn btn-primary edit-button">
                <span class="oi oi-pencil"></span> Éditer
            </button>
        }
        else
        {
            <button @onclick="SaveChanges" class="btn btn-success save-button">
                <span class="oi oi-check"></span> Enregistrer
            </button>
            <button @onclick="CancelEdit" class="btn btn-secondary cancel-button">
                <span class="oi oi-x"></span> Annuler
            </button>
        }
    </div>

    <div class="personnage-detail-container">
        <div class="container py-4">
            <div class="card shadow-lg">
                <div class="card-body">
                    @if (!isEditing)
                    {
                        <!-- Mode Lecture -->
                        <div class="row">
                            <div class="col-md-12 text-center mb-4">
                                <img src="@currentPerso.ImageUrlSelected" alt="@currentPerso.Nom" class="detail-personnage-image" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="section-title">Informations Générales</h5>
                                
                                <div class="detail-item">
                                    <label>Nom :</label>
                                    <span class="value">@currentPerso.Nom</span>
                                </div>

                                <div class="detail-item">
                                    <label>Rareté :</label>
                                    <span class="value badge bg-@GetRarityClass(currentPerso.Rarete)">@currentPerso.Rarete</span>
                                </div>

                                <div class="detail-item">
                                    <label>Type :</label>
                                    <span class="value">@currentPerso.Type</span>
                                </div>

                                <div class="detail-item">
                                    <label>Rôle :</label>
                                    <span class="value">@currentPerso.Role</span>
                                </div>

                                <div class="detail-item">
                                    <label>Faction :</label>
                                    <span class="value">@currentPerso.Faction</span>
                                </div>

                                <div class="detail-item">
                                    <label>Type d'Attaque :</label>
                                    <span class="value">@currentPerso.TypeAttaque</span>
                                </div>

                                <div class="detail-item">
                                    <label>Rang :</label>
                                    <div class="stars">@RenderStars(currentPerso.Rang)</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="section-title">Statistiques</h5>
                                
                                <div class="detail-item">
                                    <label>Niveau :</label>
                                    <span class="value badge bg-info">@currentPerso.Niveau</span>
                                </div>

                                <div class="detail-item">
                                    <label>Puissance :</label>
                                    <span class="value badge bg-warning">@currentPerso.Puissance</span>
                                </div>

                                <div class="detail-item">
                                    <label>PA (Points d'Attaque) :</label>
                                    <span class="value">@currentPerso.PA</span>
                                </div>

                                <div class="detail-item">
                                    <label>PV (Points de Vie) :</label>
                                    <span class="value">@currentPerso.PV</span>
                                </div>

                                <div class="detail-item">
                                    <label>Sélectionné :</label>
                                    <span class="value">
                                        @if (currentPerso.Selectionne)
                                        {
                                            <span class="badge bg-success">✓ Oui</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Non</span>
                                        }
                                    </span>
                                </div>

                                @if (currentPerso.Type == TypePersonnage.Commandant)
                                {
                                    var seuil = PersonnageService.GetPuissanceSeuilCommandantPourLvlUp();
                                    var puissanceMax = PersonnageService.GetPuissanceMaxEscouade();
                                    var peutMonter = puissanceMax >= seuil;
                                    <div class="mt-3">
                                        <h6 class="section-title">Seuil de Puissance pour Level Up</h6>
                                        <div class="detail-item">
                                            <label>Puissance escouade :</label>
                                            <span class="value badge bg-warning">@puissanceMax</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Seuil requis :</label>
                                            <span class="value badge bg-primary">@seuil</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Statut :</label>
                                            <span class="value badge @(peutMonter ? "bg-success" : "bg-danger")">@(peutMonter ? "✓ Suffisant" : "Insuffisant")</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(currentPerso.Description))
                        {
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="section-title">Description</h5>
                                    <p class="description-text">@currentPerso.Description</p>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <!-- Mode Édition -->
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="section-title">Informations Générales</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nom</label>
                                    <input type="text" class="form-control" @bind="editedPerso.Nom" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Rareté</label>
                                    <select class="form-select" @bind="editedPerso.Rarete">
                                        @foreach (Rarete rarete in Enum.GetValues(typeof(Rarete)))
                                        {
                                            <option value="@rarete">@rarete</option>
                                        }
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" @bind="editedPerso.Type">
                                        @foreach (TypePersonnage type in Enum.GetValues(typeof(TypePersonnage)))
                                        {
                                            <option value="@type">@type</option>
                                        }
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Rôle</label>
                                    <select class="form-select" @bind="editedPerso.Role">
                                        @foreach (Role role in Enum.GetValues(typeof(Role)))
                                        {
                                            <option value="@role">@role</option>
                                        }
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Faction</label>
                                    <select class="form-select" @bind="editedPerso.Faction">
                                        @foreach (Faction faction in Enum.GetValues(typeof(Faction)))
                                        {
                                            <option value="@faction">@faction</option>
                                        }
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Type d'Attaque</label>
                                    <select class="form-select" @bind="editedPerso.TypeAttaque">
                                        @foreach (TypeAttaque typeAttaque in Enum.GetValues(typeof(TypeAttaque)))
                                        {
                                            <option value="@typeAttaque">@typeAttaque</option>
                                        }
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Rang (0-7)</label>
                                    <input type="number" class="form-control" @bind="editedPerso.Rang" min="0" max="7" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="section-title">Statistiques</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">Niveau</label>
                                    <input type="number" class="form-control" @bind="editedPerso.Niveau" min="1" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Puissance</label>
                                    <input type="number" class="form-control" @bind="editedPerso.Puissance" min="0" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">PA (Points d'Attaque)</label>
                                    <input type="number" class="form-control" @bind="editedPerso.PA" min="0" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">PV (Points de Vie)</label>
                                    <input type="number" class="form-control" @bind="editedPerso.PV" min="0" />
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" @bind="editedPerso.Selectionne" id="selectionneCheck" />
                                        <label class="form-check-label" for="selectionneCheck">
                                            Sélectionné
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" @bind="editedPerso.Description" rows="4"></textarea>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container mt-4">
        <div class="alert alert-danger">Personnage non trouvé</div>
    </div>
}

