name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Get version from tag
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
          $version = $matches[1]
        } else {
          $version = "1.0.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Restore dependencies
      run: dotnet restore CharacterManager/CharacterManager.csproj
    
    - name: Build Windows x64
      run: |
        dotnet publish CharacterManager/CharacterManager.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ./publish/win-x64 `
          -p:PublishSingleFile=true `
          -p:PublishTrimmed=false `
          -p:IncludeNativeLibrariesForSelfExtract=true
    
    - name: Build Linux x64
      run: |
        dotnet publish CharacterManager/CharacterManager.csproj `
          --configuration Release `
          --runtime linux-x64 `
          --self-contained true `
          --output ./publish/linux-x64 `
          -p:PublishSingleFile=true `
          -p:PublishTrimmed=false `
          -p:IncludeNativeLibrariesForSelfExtract=true
    
    - name: Create Windows ZIP
      shell: pwsh
      run: |
        Compress-Archive -Path ./publish/win-x64/* -DestinationPath CharacterManager-${{ steps.get_version.outputs.VERSION }}-win-x64.zip
    
    - name: Create Linux TAR.GZ
      shell: pwsh
      run: |
        tar -czf CharacterManager-${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz -C ./publish/linux-x64 .
    
    - name: Generate Release Notes
      id: release_notes
      shell: pwsh
      run: |
        $notes = @"
        ## Character Manager v${{ steps.get_version.outputs.VERSION }}
        
        ### üì¶ Installation
        
        **Windows:**
        1. T√©l√©chargez ``CharacterManager-${{ steps.get_version.outputs.VERSION }}-win-x64.zip``
        2. Extrayez le contenu dans un dossier
        3. Ex√©cutez ``CharacterManager.exe``
        4. Ouvrez votre navigateur √† l'adresse: http://localhost:5269
        
        **Linux:**
        1. T√©l√©chargez ``CharacterManager-${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz``
        2. Extrayez: ``tar -xzf CharacterManager-${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz``
        3. Rendez ex√©cutable: ``chmod +x CharacterManager``
        4. Lancez: ``./CharacterManager``
        5. Ouvrez votre navigateur √† l'adresse: http://localhost:5269
        
        ### üê≥ Docker
        ``````bash
        docker pull ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}
        docker run -p 5269:8080 -v ./data:/app/data ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}
        ``````
        
        ### üîÑ Mise √† jour
        L'application v√©rifie automatiquement les mises √† jour disponibles au d√©marrage.
        "@
        
        # Sauvegarder dans un fichier
        $notes | Out-File -FilePath release_notes.md -Encoding utf8
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          CharacterManager-${{ steps.get_version.outputs.VERSION }}-win-x64.zip
          CharacterManager-${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      run: |
        echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker build -t ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }} .
        docker tag ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }} ghcr.io/${{ github.repository }}:latest
        docker push ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}
        docker push ghcr.io/${{ github.repository }}:latest
